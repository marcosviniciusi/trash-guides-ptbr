version: '3.8'

services:
  # Download autom√°tico dos Custom Formats
  download-formats:
    image: curlimages/curl:latest
    container_name: configarr-download
    command: >
      sh -c "
      BASE_URL='https://raw.githubusercontent.com/marcosviniciusi/trash-guides-ptbr/refs/heads/main/custom-formats'
      
      # Criar diret√≥rio se n√£o existir
      mkdir -p /config/custom-formats
      
      echo 'üì• Baixando custom formats...'
      
      # Fun√ß√£o para baixar com tratamento de erro
      download_format() {
          local file=$$1
          echo '  ‚Üí '$$file
          curl -fsSL "$$BASE_URL/$$file" -o "/config/custom-formats/$$file" || {
              echo '‚ùå Erro ao baixar '$$file
              return 1
          }
      }
      
      # Custom Formats Globais DUAL AUDIO
      download_format 'custom-web-tier-ptbr-dual.json'

      # Custom Formats Globais Legendados
      download_format 'custom-web-tier-ptbr-leg.json'
      download_format 'custom-web-tier-ptbr-leg-not-group.json'
      download_format 'custom-web-tier-ptbr-leg-bad-group.json'
      
      # Custom Formats Globais Dublados
      download_format 'custom-web-tier-ptbr-dub.json'
      download_format 'custom-web-tier-ptbr-dub-not-group.json'
      download_format 'custom-web-tier-ptbr-dub-bad-group.json'
      
      # Radarr
      download_format 'custom-animes-not-brazilian-radarr.json'
      download_format 'custom-animes-not-original-radarr.json'
      download_format 'custom-animes-not-portuguese-radarr.json'
      download_format 'custom-animes-toonshub-pt-radarr.json'
      download_format 'custom-animes-toonshub-ptbr-radarr.json'
      
      # Sonarr
      download_format 'custom-animes-not-brazilian-sonarr.json'
      download_format 'custom-animes-not-original-sonarr.json'
      download_format 'custom-animes-not-portuguese-sonarr.json'
      download_format 'custom-animes-toonshub-pt-sonarr.json'
      download_format 'custom-animes-toonshub-ptbr-sonarr.json'
      
      echo '‚úÖ Custom formats baixados com sucesso!'
      "
    volumes:
      - custom-formats:/config
    restart: "no"
  
  # Configarr
  configarr:
    image: ghcr.io/raydak-labs/configarr:latest
    container_name: configarr
    depends_on:
      download-formats:
        condition: service_completed_successfully
    volumes:
      - ./config/config.yml:/app/config/config.yml:ro
      - ./secrets/secrets.yml:/app/config/secrets.yml:ro
      - custom-formats:/config:ro
      - app-data:/app/repos
    environment:
      - LOG_STACKTRACE=true
      - OTEL_LOG_LEVEL=debug
    network_mode: bridge
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.configarr-sync.schedule: "0 2 * * *"
      ofelia.job-exec.configarr-sync.command: "/app/configarr"
  
  # Scheduler Ofelia
  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia-scheduler
    depends_on:
      - configarr
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

volumes:
  custom-formats:
  app-data: