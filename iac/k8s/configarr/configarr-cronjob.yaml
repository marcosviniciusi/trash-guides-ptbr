apiVersion: batch/v1
kind: CronJob
metadata:
  name: configarr-sync
  namespace: arr
spec:
  schedule: "0 */6 * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          initContainers:
            - name: download-custom-formats
              image: curlimages/curl:latest
              command:
                - sh
                - -c
                - |
                  set -e
                  echo "üì• Baixando custom formats do GitHub..."
                  mkdir -p /config/custom_formats
                  
                  BASE_URL="https://raw.githubusercontent.com/marcosviniciusi/trash-guides-ptbr/refs/heads/develop/custom-formats"
                  
                  # Fun√ß√£o para download com retry
                  download_format() {
                    local file=$1
                    echo "  ‚Üí Baixando: $file"
                    curl -fsSL --retry 3 --retry-delay 2 "$BASE_URL/$file" \
                      -o "/config/custom_formats/$file" || {
                      echo "‚ùå Erro ao baixar $file"
                      return 1
                    }
                  }
                  
                  # Custom Formats Globais Legendados
                  download_format "custom-web-tier-ptbr-dual.json"
                  download_format "custom-web-tier-ptbr-leg.json"
                  download_format "custom-web-tier-ptbr-leg-not-group.json"
                  download_format "custom-web-tier-ptbr-leg-bad-group.json"
                  
                  # Custom Formats Globais Legendados
                  download_format "custom-web-tier-ptbr-dual.json"
                  download_format "custom-web-tier-ptbr-dub.json"
                  download_format "custom-web-tier-ptbr-dub-not-group.json"
                  download_format "custom-web-tier-ptbr-dub-bad-group.json"
                  
                  # Radarr
                  download_format "custom-animes-not-brazilian-radarr.json"
                  download_format "custom-animes-not-original-radarr.json"
                  download_format "custom-animes-not-portuguese-radarr.json"
                  download_format "custom-animes-toonshub-pt-radarr.json"
                  download_format "custom-animes-toonshub-ptbr-radarr.json"
                  
                  # Sonarr
                  download_format "custom-animes-not-brazilian-sonarr.json"
                  download_format "custom-animes-not-original-sonarr.json"
                  download_format "custom-animes-not-portuguese-sonarr.json"
                  download_format "custom-animes-toonshub-pt-sonarr.json"
                  download_format "custom-animes-toonshub-ptbr-sonarr.json"
                  
                  echo "‚úÖ Todos os custom formats foram baixados!"
                  ls -lah /config/custom_formats/                 
              volumeMounts:
                - name: custom-formats-storage
                  mountPath: /config
          
          containers:
            - name: configarr
              image: ghcr.io/raydak-labs/configarr:latest
              imagePullPolicy: Always
              env:
                - name: LOG_STACKTRACE
                  value: "true"
                - name: OTEL_LOG_LEVEL
                  value: "debug"
              volumeMounts:
                - name: app-data
                  mountPath: /app/repos
                  subPath: configarr-repos
                - name: configarr-config
                  mountPath: /app/config/config.yml
                  subPath: config.yml
                - name: secret-volume
                  mountPath: /app/config/secrets.yml
                  subPath: secrets_yml
                - name: custom-formats-storage
                  mountPath: /config
                  readOnly: true

          restartPolicy: Never
          volumes:
            - name: custom-formats-storage
              emptyDir: {}
            - name: app-data
              persistentVolumeClaim:
                claimName: configarr
            - name: configarr-config
              configMap:
                name: configarr-config
            - name: secret-volume
              secret:
                secretName: configarr-secrets