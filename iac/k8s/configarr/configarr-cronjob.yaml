apiVersion: batch/v1
kind: CronJob
metadata:
  name: configarr-sync
spec:
  schedule: "*/10 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          initContainers:
            - name: download-custom-formats
              image: curlimages/curl:latest
              command:
                - sh
                - -c
                - |
                  set -e
                  echo "üì• Baixando custom formats do GitHub..."
                  mkdir -p /config/custom_formats
                  
                  BASE_URL="https://raw.githubusercontent.com/marcosviniciusi/trash-guides-ptbr/refs/heads/develop/custom-formats"
                  
                  # Fun√ß√£o para download com retry
                  download_format() {
                    local file=$1
                    echo "  ‚Üí Baixando: $file"
                    curl -fsSL --retry 3 --retry-delay 2 "$BASE_URL/$file" \
                      -o "/config/custom_formats/$file" || {
                      echo "‚ùå Erro ao baixar $file"
                      return 1
                    }
                  }
                  
                  # Custom Novos
                  download_format 'custom-pt-br-dual-audio.json'
                  download_format 'custom-pt-br-dual-language.json'
                  download_format 'custom-pt-br-dublado-language.json'
                  download_format 'custom-pt-br-dublado.json'
                  download_format 'custom-pt-br-legendado.json'
                  download_format 'custom-pt-br-original-language.json'
                  download_format 'custom-pt-br-web-tier-bad-group.json'
                  download_format 'custom-pt-br-web-tier.json'
                  download_format 'custom-pt-br-globoplay.json'
                  
                  echo "‚úÖ Todos os custom formats foram baixados!"
                  ls -lah /config/custom_formats/                 
              volumeMounts:
                - name: custom-formats-storage
                  mountPath: /config
          
          containers:
            - name: configarr
              image: ghcr.io/raydak-labs/configarr:latest
              imagePullPolicy: Always
              env:
                - name: LOG_STACKTRACE
                  value: "true"
                - name: OTEL_LOG_LEVEL
                  value: "debug"
              volumeMounts:
                - name: app-data
                  mountPath: /app/repos
                  subPath: configarr-repos
                - name: configarr-config
                  mountPath: /app/config/config.yml
                  subPath: config.yml
                - name: secret-volume
                  mountPath: /app/config/secrets.yml
                  subPath: secrets_yml
                - name: custom-formats-storage
                  mountPath: /config
                  readOnly: true

          restartPolicy: Never
          volumes:
            - name: custom-formats-storage
              emptyDir: {}
            - name: app-data
              persistentVolumeClaim:
                claimName: configarr
            - name: configarr-config
              configMap:
                name: configarr-config
            - name: secret-volume
              secret:
                secretName: configarr-secrets  # ‚Üê MUDOU AQUI: de configarr-secrets para configarr